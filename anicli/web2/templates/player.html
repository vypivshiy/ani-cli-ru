{% extends "base.html" %}
{% block content %}
    <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
        <a href="/anime/{{ anime_uid }}" class="btn-sm">← Back to Episodes</a>
        <span style="font-weight: bold;">{{ title }}</span>
    </div>
    
    <div class="player-container">
        <div class="video-box">
            <div id="artplayer"></div>
        </div>

        <div class="controls-box">
            
            <div style="border-bottom: 1px solid #444; padding-bottom: 1rem;">
                <label>Episode Navigation</label>
                <div class="nav-row">
                    {% if nav.prev_uid %}
                        <a href="/play/{{ nav.prev_uid }}?anime_uid={{ anime_uid }}">
                            <button class="btn-sm">Prev</button>
                        </a>
                    {% else %}
                        <button class="btn-sm" disabled style="opacity: 0.3">Prev</button>
                    {% endif %}

                    <form action="/play_jump" method="get" style="display: flex; gap: 5px; margin: 0;">
                        <input type="hidden" name="anime_uid" value="{{ anime_uid }}">
                        <input type="number" name="ep_num" class="nav-input" value="{{ nav.current_num }}" required>
                        <button type="submit" class="btn-sm">Go</button>
                    </form>

                    {% if nav.next_uid %}
                        <a href="/play/{{ nav.next_uid }}?anime_uid={{ anime_uid }}">
                            <button class="btn-sm">Next</button>
                        </a>
                    {% else %}
                        <button class="btn-sm" disabled style="opacity: 0.3">Next</button>
                    {% endif %}
                </div>
            </div>

            <div>
                <label>Source / Dubbing</label>
                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #444; border-radius: 4px;">
                    {% for src in sources %}
                    <a href="?anime_uid={{ anime_uid }}&source_index={{ src.index }}" 
                       class="source-item {% if src.selected %}active-source{% endif %}">
                        {{ src.title }}
                        <small>{{ src.netloc }}</small>
                    </a>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>

    <script>
        const qualityList = {{ quality_json | safe }};
        const defaultUrl = "{{ default_url }}";
        const defaultType = "{{ default_type }}";

        function playM3u8(video, url, art) {
            if (Hls.isSupported()) {
                if (art.hls) art.hls.destroy();
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                art.hls = hls;
                art.on('destroy', () => hls.destroy());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
            } else {
                art.notice.show = 'Unsupported format: m3u8';
            }
        }

        function playMpd(video, url, art) {
            if (art.dash) art.dash.destroy();
            const dash = dashjs.MediaPlayer().create();
            dash.initialize(video, url, art.option.autoplay);
            art.dash = dash;
            art.on('destroy', () => dash.destroy());
        }

        var art = new Artplayer({
            container: '#artplayer',
            url: defaultUrl,
            type: defaultType,
            quality: qualityList,
            setting: true,
            fullscreen: true,
            fullscreenWeb: true,
            autoplay: false,
            autoSize: false, // Важно для responsive CSS
            customType: {
                m3u8: playM3u8,
                mpd: playMpd
            }
        });
        
        // Автоматическое воспроизведение следующего эпизода (опционально)
        art.on('video:ended', () => {
             // Можно раскомментировать для auto-next
             // const nextBtn = document.querySelector('a[href*="next_uid"]');
             // if(nextBtn) nextBtn.click();
        });
    </script>
{% endblock %}